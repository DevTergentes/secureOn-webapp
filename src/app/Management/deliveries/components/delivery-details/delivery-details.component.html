<div class="delivery-details-container">
  <div class="header">
    <h2>Delivers</h2>
    <h4>Delivery Trips</h4>
    <img
      src="https://github.com/user-attachments/assets/63ca6961-f592-49cd-a7d1-0a646b71ae12"
      alt="Delivery Icon"
      class="delivery-icon"
    />
  </div>

  <div class="delivery-details-grid">
    <!-- Card 1: Detalles de la entrega -->
    <mat-card class="delivery-details-card" *ngIf="delivery">
      <div class="delivery-details-header">
        <h3>{{ delivery.destination }}</h3>
        <p>{{ delivery.packageDescription }}</p>
      </div>
      <div class="delivery-details-body">
        <div class="delivery-details-body-subtitle">
          <p>Route Details</p>
        </div>
        <p>Salida: <span>{{ delivery.exitPoint }}</span></p>
        <p>Ruta Principal: <span>{{ delivery.route }}</span></p>
        <p>Parada: <span>{{ delivery.stop }}</span></p>
        <p>Llegada: <span>{{ delivery.destination }}</span></p>
        <div class="delivery-details-body-subtitle">
          <p>Combustible type</p>
        </div>
        <p>{{ delivery.combustibleType }}</p>
      </div>
    </mat-card>

    <!-- Card 2: Sensor + Último Record + Tabla de records -->
    <mat-card class="delivery-details-card" *ngIf="device || latestRecordBeeceptor">
      <div class="delivery-details-header">
        <h3>Sensor</h3>
        <p *ngIf="device">Id: {{ device.id }}</p>
        <p *ngIf="device">
          Safe:
          <span [ngClass]="device.safe ? 'safe-badge' : 'unsafe-badge'">
            {{ device.safe ? 'Safe' : 'Unsafe' }}
          </span>
        </p>
        <h3 style="margin-top: 22px;">Último Record</h3>
        <ng-container *ngIf="latestRecordBeeceptor">
          <p>Gas: {{ latestRecordBeeceptor.gasValue }}</p>
          <p>Ritmo cardiaco: {{ latestRecordBeeceptor.heartRateValue }}</p>
          <p>Temperatura: {{ latestRecordBeeceptor.temperatureValue }} °C</p>
          <p>
            Fecha:
            {{ latestRecordBeeceptor.timestamp | date:'dd/MM/yyyy HH:mm' }}
          </p>
        </ng-container>
      </div>

      <!-- Tabla de últimos records -->
      <div *ngIf="recordsBeeceptor && recordsBeeceptor.length > 0" class="records-table-container">
        <h4>Historial de registros recientes</h4>
        <table class="records-table">
          <thead>
          <tr>
            <th>Fecha</th>
            <th>Gas</th>
            <th>Temp (°C)</th>
            <th>BPM</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let r of recordsBeeceptor.slice(-5)">
            <td>
              {{ latestRecordBeeceptor.timestamp | date:'dd/MM/yyyy HH:mm' }}
            </td>
            <td>{{ r.gasValue }}</td>
            <td>{{ r.temperatureValue }}</td>
            <td>{{ r.heartRateValue }}</td>
          </tr>
          </tbody>
        </table>
      </div>
    </mat-card>
  </div>

  <!-- Mapa centrado y ancho -->
  <div class="delivery-details-map-container" *ngIf="latestRecordBeeceptor?.latitude && latestRecordBeeceptor?.longitude">
    <iframe
      [src]="getMapUrl(latestRecordBeeceptor.latitude, latestRecordBeeceptor.longitude)"
      allowfullscreen
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade"
      class="big-map-iframe"
    ></iframe>
  </div>

  <div class="buttons">
    <button class="completed-button" (click)="markAsCompleted()">Mark as Completed</button>
    <button class="return-button" (click)="returnToDeliveries()">Return Home</button>
  </div>
</div>
