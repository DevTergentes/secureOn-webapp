<!-- Vista de Incidentes Redise√±ada -->
<div class="incidents-container">
  <div class="header">
    <h1>Monitor de Incidentes</h1>
  </div>

  <mat-card class="search-card">
    <div class="search-container">
      <input matInput placeholder="Buscar por destino o descripci√≥n..." [(ngModel)]="searchText"
             (input)="filterIncidents()" />
      <button mat-icon-button class="search-button">
        <i class="fa-solid fa-magnifying-glass" style="color: #ffffff;"></i>
      </button>
    </div>
  </mat-card>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading-container">
    <mat-icon class="spinning">refresh</mat-icon>
    <p>Cargando incidentes...</p>
  </div>

  <!-- Lista de Deliveries con sus Incidentes -->
  <div class="deliveries-list" *ngIf="!loading">
    <mat-expansion-panel
      class="delivery-panel"
      *ngFor="let item of deliveriesWithIncidents">

      <!-- Header del Panel -->
      <mat-expansion-panel-header>
        <mat-panel-title>
          <div class="delivery-header">
            <div class="delivery-info">
              <div class="delivery-main-info">
                <h3 class="delivery-title">{{item.delivery.destination}}</h3>
                <span class="delivery-state" [class]="'state-' + item.delivery.state.toLowerCase()">
                  {{item.delivery.state}}
                </span>
              </div>
              <p class="delivery-description">{{item.delivery.packageDescription}}</p>
            </div>
            <div class="incidents-summary">
              <mat-chip-set>
                <mat-chip *ngIf="item.manualIncidents.length > 0"
                         class="chip-manual priority-chip">
                  <mat-icon>person</mat-icon>
                  {{item.manualIncidents.length}} Conductor
                </mat-chip>
                <mat-chip *ngIf="item.automaticIncidents.length > 0"
                         class="chip-automatic">
                  <mat-icon>sensors</mat-icon>
                  {{item.automaticIncidents.length}} Sensor
                </mat-chip>
                <mat-chip *ngIf="item.totalIncidents === 0"
                         class="chip-safe">
                  <mat-icon>check_circle</mat-icon>
                  Sin incidentes
                </mat-chip>
              </mat-chip-set>
            </div>
          </div>
        </mat-panel-title>
      </mat-expansion-panel-header>

      <!-- Contenido del Panel -->
      <div class="panel-content">

        <!-- Incidentes Reportados por Conductor (PRIMERO) -->
        <div class="incidents-section" *ngIf="item.manualIncidents.length > 0">
          <h4><mat-icon>person</mat-icon> Incidentes Reportados por Conductor</h4>
          <div class="incidents-grid">
            <mat-card
              class="incident-card manual"
              *ngFor="let incident of item.manualIncidents">
              <mat-card-header>
                <div class="incident-card-header">
                  <mat-icon class="incident-icon manual-icon">report</mat-icon>
                  <div class="incident-title-section">
                    <mat-card-title class="incident-title">{{incident.incidentPlace}}</mat-card-title>
                    <mat-card-subtitle class="incident-subtitle">{{formatDateOnly(incident.date)}}</mat-card-subtitle>
                  </div>
                </div>
              </mat-card-header>
              <mat-card-content class="incident-content">
                <p class="incident-description">{{incident.description}}</p>
                <div class="incident-details">
                  <span class="detail-tag"><strong>Servicio ID:</strong> {{incident.serviceId}}</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <!-- Incidentes Autom√°ticos (Sensores) - SEGUNDO -->
        <div class="incidents-section" *ngIf="item.automaticIncidents.length > 0">
          <h4><mat-icon>sensors</mat-icon> Incidentes Detectados por Sensores</h4>
          <div class="incidents-grid">
            <mat-card
              class="incident-card automatic"
              *ngFor="let incident of item.automaticIncidents"
              [class]="getSeverityClass(incident.severity)">
              <mat-card-header>
                <div class="incident-card-header">
                  <mat-icon class="incident-icon automatic-icon" [color]="incident.severity === 'CRITICAL' ? 'warn' : 'primary'">
                    {{getSensorIcon(incident.source)}}
                  </mat-icon>
                  <div class="incident-title-section">
                    <mat-card-title class="incident-title">
                      {{incident.source === 'GAS' ? 'Gas' : incident.source === 'TEMPERATURE' ? 'Temperatura' : 'Ritmo Card√≠aco'}}
                      - {{incident.severity}}
                    </mat-card-title>
                    <mat-card-subtitle class="incident-subtitle">{{formatDate(incident.timestamp)}}</mat-card-subtitle>
                  </div>
                </div>
              </mat-card-header>
              <mat-card-content class="incident-content">
                <p class="incident-message">{{incident.message}}</p>
                <div class="incident-details">
                  <span class="detail-tag"><strong>Valor actual:</strong>
                    {{incident.value}}{{incident.source === 'GAS' ? ' ppm' : incident.source === 'TEMPERATURE' ? ' ¬∞C' : ' BPM'}}
                  </span>
                  <span class="detail-tag"><strong>Umbral superado:</strong>
                    {{incident.threshold}}{{incident.source === 'GAS' ? ' ppm' : incident.source === 'TEMPERATURE' ? ' ¬∞C' : ' BPM'}}
                  </span>
                  <span class="detail-tag"><strong>Sensor ID:</strong> {{incident.sensorId}}</span>
                  <span class="severity-badge" [class]="getSeverityClass(incident.severity)">
                    {{incident.severity}}
                  </span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <!-- Informaci√≥n del Sensor -->
        <div class="sensor-info-section" *ngIf="item.sensors.length > 0 || item.latestRecords.length > 0">
          <h4><mat-icon>sensors</mat-icon> Informaci√≥n del Sensor</h4>

          <!-- Estado del Sensor -->
          <mat-card class="sensor-status-card" *ngFor="let sensor of item.sensors">
            <mat-card-header>
              <mat-icon mat-card-avatar [color]="sensor.safe ? 'primary' : 'warn'">
                {{sensor.safe ? 'check_circle' : 'warning'}}
              </mat-icon>
              <mat-card-title>Sensor {{sensor.id}}</mat-card-title>
              <mat-card-subtitle>Estado: {{sensor.safe ? 'Seguro' : 'Alerta'}}</mat-card-subtitle>
            </mat-card-header>
          </mat-card>

          <!-- √öltimo Record -->
          <mat-card class="latest-record-card" *ngIf="item.latestRecords.length > 0">
            <mat-card-header>
              <mat-icon mat-card-avatar color="accent">schedule</mat-icon>
              <mat-card-title>√öltimo Record</mat-card-title>
              <mat-card-subtitle>{{formatDate(item.latestRecords[item.latestRecords.length - 1]?.timestamp)}}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="sensor-readings" *ngIf="item.latestRecords.length > 0">
                <div class="reading-item">
                  <mat-icon color="warn">warning</mat-icon>
                  <span class="reading-label">Gas:</span>
                  <span class="reading-value">{{item.latestRecords[item.latestRecords.length - 1]?.gasValue}} ppm</span>
                  <span class="reading-status" [class]="getGasStatusClass(item.latestRecords[item.latestRecords.length - 1]?.gasValue)">
                    {{getGasStatus(item.latestRecords[item.latestRecords.length - 1]?.gasValue)}}
                  </span>
                </div>
                <div class="reading-item">
                  <mat-icon color="primary">thermostat</mat-icon>
                  <span class="reading-label">Temperatura:</span>
                  <span class="reading-value">{{item.latestRecords[item.latestRecords.length - 1]?.temperatureValue}} ¬∞C</span>
                  <span class="reading-status" [class]="getTemperatureStatusClass(item.latestRecords[item.latestRecords.length - 1]?.temperatureValue)">
                    {{getTemperatureStatus(item.latestRecords[item.latestRecords.length - 1]?.temperatureValue)}}
                  </span>
                </div>
                <div class="reading-item">
                  <mat-icon color="accent">favorite</mat-icon>
                  <span class="reading-label">Ritmo card√≠aco:</span>
                  <span class="reading-value">{{item.latestRecords[item.latestRecords.length - 1]?.heartRateValue}} BPM</span>
                  <span class="reading-status" [class]="getHeartRateStatusClass(item.latestRecords[item.latestRecords.length - 1]?.heartRateValue)">
                    {{getHeartRateStatus(item.latestRecords[item.latestRecords.length - 1]?.heartRateValue)}}
                  </span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Umbrales de Advertencia -->
          <mat-card class="thresholds-card">
            <mat-card-header>
              <mat-icon mat-card-avatar color="warn">rule</mat-icon>
              <mat-card-title>Umbrales de Seguridad</mat-card-title>
              <mat-card-subtitle>L√≠mites que no deben superarse</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="thresholds-grid">
                <div class="threshold-item">
                  <h5><mat-icon>warning</mat-icon> Gas (ppm)</h5>
                  <div class="threshold-levels">
                    <span class="level warning">‚ö†Ô∏è Advertencia: ‚â•40</span>
                    <span class="level danger">üî∂ Peligro: ‚â•60</span>
                    <span class="level critical">üî¥ Cr√≠tico: ‚â•80</span>
                  </div>
                </div>
                <div class="threshold-item">
                  <h5><mat-icon>thermostat</mat-icon> Temperatura (¬∞C)</h5>
                  <div class="threshold-levels">
                    <span class="level warning">‚ùÑÔ∏è Fr√≠o: ‚â§5¬∞C</span>
                    <span class="level warning">‚ö†Ô∏è Calor: ‚â•35¬∞C</span>
                    <span class="level danger">üî∂ Peligro: ‚â§0¬∞C o ‚â•40¬∞C</span>
                    <span class="level critical">üî¥ Cr√≠tico: ‚â•45¬∞C</span>
                  </div>
                </div>
                <div class="threshold-item">
                  <h5><mat-icon>favorite</mat-icon> Ritmo Card√≠aco (BPM)</h5>
                  <div class="threshold-levels">
                    <span class="level warning">‚ö†Ô∏è Bajo: ‚â§50</span>
                    <span class="level warning">‚ö†Ô∏è Alto: ‚â•120</span>
                    <span class="level danger">üî∂ Peligro: ‚â§40 o ‚â•140</span>
                    <span class="level critical">üî¥ Cr√≠tico: ‚â•160</span>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Historial de Registros Recientes -->
          <mat-card class="recent-records-card" *ngIf="item.latestRecords.length > 1">
            <mat-card-header>
              <mat-icon mat-card-avatar color="primary">history</mat-icon>
              <mat-card-title>Historial de Registros Recientes</mat-card-title>
              <mat-card-subtitle>√öltimas {{item.latestRecords.length}} lecturas</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="records-table">
                <table>
                  <thead>
                    <tr>
                      <th>Fecha</th>
                      <th>Gas (ppm)</th>
                      <th>Temp (¬∞C)</th>
                      <th>BPM</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let record of item.latestRecords">
                      <td>{{formatDate(record.timestamp)}}</td>
                      <td [class]="getGasStatusClass(record.gasValue)">{{record.gasValue}}</td>
                      <td [class]="getTemperatureStatusClass(record.temperatureValue)">{{record.temperatureValue}}</td>
                      <td [class]="getHeartRateStatusClass(record.heartRateValue)">{{record.heartRateValue}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Sin incidentes -->
        <div class="no-incidents" *ngIf="item.totalIncidents === 0">
          <mat-icon color="primary">check_circle</mat-icon>
          <h4>Sin incidentes reportados</h4>
          <p>Este delivery no presenta incidentes autom√°ticos ni manuales.</p>
        </div>

      </div>
    </mat-expansion-panel>
  </div>

  <!-- Mensaje cuando no hay deliveries -->
  <div class="no-data" *ngIf="!loading && deliveriesWithIncidents.length === 0">
    <mat-icon>info</mat-icon>
    <h3>No hay deliveries disponibles</h3>
    <p *ngIf="isEmployee()">No tienes deliveries asignados.</p>
    <p *ngIf="!isEmployee()">No hay deliveries registrados en el sistema.</p>
  </div>

  <!-- Bot√≥n flotante para agregar incidente - solo para empleados -->
  <button *ngIf="isEmployee()"
          mat-fab
          class="floating-add-btn"
          (click)="addIncident()">
    <mat-icon>add</mat-icon>
  </button>
</div>
